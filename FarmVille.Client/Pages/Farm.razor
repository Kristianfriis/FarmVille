@page "/Farm/{FarmId:int}"
@inject FarmService FarmService
@inject CropService CropService
@inject GameState GameState
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@inject SnackbarService Snackbar

@implements IAsyncDisposable

<GameHud FarmId="FarmId" Coins="GameState.PlayerInventory.Coins" XP="XP" OnSaveGame="SaveGame" />

<div id="farm-viewport" class="farm-viewport">

    <div class="farm-world" style="transform: translate3d(@(OffsetX)px, @(OffsetY)px, 0px);">
        <div class="farm-grid" style="grid-template-columns: repeat(20, 64px);">
            @foreach (var tile in FarmGrid)
            {
                <div class="tile @tile.Status.ToString().ToLower() @(MarkSelectedTile(tile)) @(IsWorkingOnTile(tile)) cell"
                    style="grid-column: @(tile.X + 1); grid-row: @(tile.Y + 1); z-index: @(tile.Y);"
                    @onclick="() => HandleTileClick(tile)" @onclick:stopPropagation>

                    @if (tile.BuildingType == "Barn")
                    {
                        <div class="barn-visual">
                            <div class="barn-roof"></div>
                            <div class="barn-doors"></div>
                            <div class="barn-shadow"></div>
                        </div>
                        <div class="building-label">THE BARN</div>
                    }
                    else
                    {
                        @* LAYER 1: The Ground *@
                        @if (tile.Status == TileStatus.Grass)
                        {
                            <Tile Type="TileType.Grass" />
                        }
                        else
                        {
                            <Tile Type="TileType.TilledSoil" />
                        }

                        @if (tile.CurrentAction != TileAction.None)
                        {
                            <ToolTip>
                                @tile.CurrentAction.ToString().ToUpper() for @(tile.GetActionRemainingTime())
                            </ToolTip>
                        }

                        @* LAYER 2: The Object/Crop (Shifted Up) *@
                        <div class="crop-layer">
                            @if (tile.Status == TileStatus.Planted)
                            {
                                <Tile Type="tile.CurrentCrop!.Stage1Type" />
                                @* <div class="tile-tooltip">@tile.CurrentCrop!.Name</div> *@
                            }
                            else if (tile.Status == TileStatus.Ready)
                            {
                                <Tile Type="tile.CurrentCrop!.ReadyType" />
                                <ToolTip>Ready</ToolTip>
                            }
                            else if (tile.Status == TileStatus.Withered)
                            {
                                <Tile Type="tile.CurrentCrop!.Stage1Type" />
                                <ToolTip>Withered</ToolTip>
                            }
                            @* Add other overlays like Chickens or Trees here *@
                        </div>

                        @* LAYER 3: UI/Tooltips *@
                        @if (tile.Status == TileStatus.Planted)
                        {
                            <ToolTip>@tile.CurrentCrop!.Name @tile.GetTimeRemaining()</ToolTip>
                        }
                    }

                </div>
            }
        </div>
    </div>
</div>

<Toolbar CurrentTool="CurrentTool" OnToolChange="ChangeTool" />

<GameModal Visible="ShowMarket" Title="SEED MARKET" OnClose="() => { ShowMarket = false; SelectedTile = null; }">
    <ChildContent>
        <div class="market-grid">
            @foreach (var crop in Crops)
            {
                <div class="market-item" @onclick="() => PlantCrop(crop)">
                    <Tile Type="crop.SeedType" />
                    <span>@crop.Name (@crop.Cost 💰)</span>
                </div>
            }
        </div>
    </ChildContent>

    <FooterContent>
        <Button Type="ButtonType.Danger" OnClick="() => { ShowMarket = false; SelectedTile = null; }">
            NEVERMIND
        </Button>
    </FooterContent>
</GameModal>

<GameAlert IsVisible="showAlert" Message="@alertMessage"
    OnClose="() => {showAlert = false; alertMessage = string.Empty;}" />

<Barn @ref="BarnRef"></Barn>

@code {
    [Parameter] public int FarmId { get; set; }
    Barn? BarnRef;

    private FarmTool CurrentTool = FarmTool.Pointer;
    private int XP = 0;
    private bool ShowMarket = false;
    private FarmTile? SelectedTile;
    private List<FarmTile> FarmGrid = new();
    private List<Crop> Crops = new();

    private double BaseX = 0; // Store the position where the drag started
    private double BaseY = 0;
    private double OffsetX = 0;
    private double OffsetY = 0;
    private int CurrentTasks = 0;
    private const int MaxConcurrentTasks = 3;
    private DotNetObjectReference<Farm>? _dotNetRef;

    private bool showAlert;
    private string alertMessage = "";

    protected override async Task OnInitializedAsync()
    {
        Crops = CropService.GetAllCrops();

        if (!await LoadGame())
        {
            GameState.PlayerInventory.AddCoins(100);

            for (int y = 0; y < 20; y++)
            {
                for (int x = 0; x < 20; x++)
                {
                    FarmGrid.Add(new FarmTile { X = x, Y = y });
                }
            }
            var barnTile = FarmGrid.FirstOrDefault(t => t.X == 2 && t.Y == 0);
            if (barnTile != null)
            {
                barnTile.Type = FarmTileType.Building;
                barnTile.BuildingType = "Barn";
            }

            await SaveGame();
        }

        GameState.PlayerInventory.OnCoinChange += () => InvokeAsync(async () => await SaveGame());

        StartHeartbeat();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        _dotNetRef = DotNetObjectReference.Create(this);

        await JSRuntime.InvokeVoidAsync(
                        "initFarmPan",
        _dotNetRef,
                        "farm-viewport"
        );
    }

    [JSInvokable]
    public void OnPanStart()
    {
        // Remember where we were when the drag started
        BaseX = OffsetX;
        BaseY = OffsetY;
    }

    [JSInvokable]
    public void OnPanMove(double deltaX, double deltaY)
    {
        OffsetX = BaseX + deltaX;
        OffsetY = BaseY + deltaY;

        ApplyBounds();
        StateHasChanged();
    }

    private async void StartHeartbeat()
    {
        while (true)
        {
            foreach (var tile in FarmGrid)
            {
                if (tile.CurrentAction != TileAction.None)
                {
                    var done = tile.UpdateActionProgress();
                    if (done)
                    {
                        tile.CurrentAction = TileAction.None;
                        tile.ActionDuration = 0;
                        CurrentTasks = Math.Max(0, CurrentTasks - 1);
                        await SaveGame();
                    }
                }
                else
                {
                    tile.UpdateState(); // Handle growth if already planted
                }
            }

            StateHasChanged();
            await Task.Delay(1000);
        }
    }

    private async Task HandleTileClick(FarmTile tile)
    {
        if (tile.Type == FarmTileType.Building)
        {
            if (tile.BuildingType == "Barn")
            {
                BarnRef?.ToggleBarn();
            }
            return;
        }

        if (tile.CurrentAction != TileAction.None) return;

        if (CurrentTool == FarmTool.Pointer && SelectedTile == tile)
        {
            SelectedTile = null;
            return;
        }

        switch (CurrentTool)
        {
            case FarmTool.Plow:
                // Only plow if it's grass or withered
                if ((tile.Status == TileStatus.Grass || tile.Status == TileStatus.Withered) && GameState.PlayerInventory.Coins >= 15)
                {
                    if (GameState.PlayerInventory.Coins < 15)
                    {
                        alertMessage = "You don't have enough coins to plow this tile! (Cost: 15)";
                        showAlert = true;
                        return;
                    }

                    if (CurrentTasks >= MaxConcurrentTasks)
                    {
                        showAlert = true;
                        alertMessage = "You are already working on the maximum number of tasks!";

                        return;
                    }

                    tile.StartAction(TileAction.Plowing, 300, 15, 1);

                    CurrentTasks++;
                    GameState.PlayerInventory.RemoveCoins(15);

                    await SaveGame();
                }
                break;

            case FarmTool.Rake:
                // Clear a tile back to grass (maybe for free?)
                tile.Status = TileStatus.Grass;
                tile.CurrentCrop = null;

                await SaveGame();
                break;

            case FarmTool.Pointer:
                // Standard interactions: Harvest or Open Market
                SelectedTile = tile;
                if (tile.Status == TileStatus.Ready)
                {
                    XP += 5;
                    tile.Status = TileStatus.Plowed;

                    GameState.PlayerInventory.AddCrop(tile.CurrentCrop!.ProduceType, tile.CurrentCrop!.HarvestAmount);

                    @* Snackbar.Show($"Stored {tile.CurrentCrop!.ProduceType}x {tile.CurrentCrop!.HarvestAmount} in the Barn!", SnackbarType.Success); *@

                    tile.CurrentCrop = null;

                    await SaveGame();
                }
                else if (tile.Status == TileStatus.Plowed)
                {
                    ShowMarket = true;
                }
                else if (tile.Status == TileStatus.Grass || tile.Status == TileStatus.Withered)
                {
                    ShowMarket = false;
                }
                break;
        }
    }

    private void ChangeTool(FarmTool tool)
    {
        CurrentTool = tool;
        switch (tool)
        {
            case FarmTool.Plow:
                ShowMarket = false;
                SelectedTile = null;
                break;
            case FarmTool.Rake:
                ShowMarket = false;
                SelectedTile = null;
                break;
        }
    }

    private string MarkSelectedTile(FarmTile tile) =>
    tile == SelectedTile ? "highlighted" : "";

    private string IsWorkingOnTile(FarmTile tile) =>
    tile.CurrentAction != TileAction.None ? "working-tile" : "";

    private async Task PlantCrop(Crop crop)
    {
        if (SelectedTile != null)
        {
            SelectedTile.CurrentCrop = crop;
            SelectedTile.PlantedAt = DateTime.Now;
            SelectedTile.Status = TileStatus.Planted;
            GameState.PlayerInventory.RemoveCoins(crop.Cost);
        }

        await SaveGame();

        ShowMarket = false;
        SelectedTile = null;
    }

    private async Task SaveGame()
    {
        var farmData = new FarmSaveData
        {
            Coins = GameState.PlayerInventory.Coins,
            XP = XP,
            Grid = FarmGrid,
            CurrentTasks = CurrentTasks,
            inventory = GameState.PlayerInventory
        };

        await FarmService.SaveFarm(FarmId, farmData);
    }

    private async Task<bool> LoadGame()
    {
        var save = await FarmService.LoadFarm(FarmId);

        if (save is not null)
        {
            FarmGrid = save.Grid.OrderBy(t => t.Y).ThenBy(t => t.X).ToList();

            XP = save.XP;
            CurrentTasks = save.CurrentTasks;

            GameState.PlayerInventory = save.inventory;
            GameState.NotifyGameLoaded();
            return true;
        }

        return false;
    }

    private void ApplyBounds()
    {
        // The size of your farm (20 tiles * 64px)
        // If you added padding in CSS, include it here
        double farmWidth = 1280;
        double farmHeight = 1280;

        // Get the current window size (you can also hardcode or use JS Interop)
        // For now, let's assume a standard "buffer"
        // We want to prevent the Offset from going too far positive (pushing farm right/down)
        // or too far negative (pushing farm left/up)

        double minX = -(farmWidth - 200); // Allow 200px to stay on screen
        double maxX = 200;

        double minY = -(farmHeight - 200);
        double maxY = 200;

        OffsetX = Math.Clamp(OffsetX, minX, maxX);
        OffsetY = Math.Clamp(OffsetY, minY, maxY);
    }

    public async ValueTask DisposeAsync()
    {
        GameState.PlayerInventory.OnCoinChange -= () => InvokeAsync(async () => await SaveGame());

        try
        {
            await JSRuntime.InvokeVoidAsync(
                        "disposeFarmPan",
                        "farm-viewport"
            );
        }
        catch
        {
            // JS runtime may already be gone during shutdown
        }

        _dotNetRef?.Dispose();
    }
}